<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Inventory Tracking</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="bn">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GMS FIRST TRACKING</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, update, set, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAC5li_-CNg0EBszOsBe4xjpqr7hyqweWI",
      authDomain: "greyfabrics-92dbd.firebaseapp.com",
      databaseURL: "https://greyfabrics-92dbd-default-rtdb.firebaseio.com",
      projectId: "greyfabrics-92dbd",
      storageBucket: "greyfabrics-92dbd.firebasestorage.app",
      messagingSenderId: "147313688926",
      appId: "1:147313688926:web:2e65894921769990f94fcf",
      measurementId: "G-9YB3E82P3T"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // Make Firebase available globally for the main script
    window.firebaseDatabase = database;
    window.firebaseRef = ref;
    window.firebaseOnValue = onValue;
    window.firebasePush = push;
    window.firebaseUpdate = update;
    window.firebaseSet = set;
    window.firebaseRemove = remove;
  </script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile Navigation Styles */
        .mobile-nav {
            display: none;
        }
        .desktop-nav {
            display: flex;
        }
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            height: 100%;
            background: white;
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .mobile-menu.open {
            left: 0;
        }
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .mobile-overlay.open {
            display: block;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .mobile-nav {
                display: block;
            }
            .desktop-nav {
                display: none;
            }
            .toast {
                right: 10px;
                left: 10px;
                width: auto;
                max-width: 90%;
            }
            
            /* Header adjustments */
            .header-title {
                font-size: 1.5rem !important;
            }
            .header-subtitle {
                font-size: 0.875rem !important;
            }
            
            /* Form adjustments */
            .form-container {
                padding: 1rem !important;
                margin: 0 0.5rem !important;
            }
            
            /* Dashboard adjustments */
            .dashboard-container {
                padding: 1rem !important;
                margin: 0 0.5rem !important;
            }
            
            /* Button adjustments */
            .mobile-stack {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            /* Table scroll */
            .table-container {
                -webkit-overflow-scrolling: touch;
                overflow-x: auto;
            }
            
            /* Statistics grid mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }
            
            /* Mobile table font */
            .mobile-table {
                font-size: 0.75rem !important;
            }
            .mobile-table th,
            .mobile-table td {
                padding: 0.25rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .header-title {
                font-size: 1.25rem !important;
            }
            .stats-grid {
                gap: 0.75rem !important;
            }
            .form-container,
            .dashboard-container {
                margin: 0 0.25rem !important;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-blue-50 to-indigo-100">
  <div id="toast-container"></div><!-- Mobile Overlay -->
  <div id="mobile-overlay" class="mobile-overlay" onclick="closeMobileMenu()"></div><!-- Mobile Menu -->
  <div id="mobile-menu" class="mobile-menu">
   <div class="p-6">
    <div class="flex justify-between items-center mb-8">
     <h2 class="text-xl font-bold text-gray-800">Menu</h2><button onclick="closeMobileMenu()" class="text-gray-500 hover:text-gray-700">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div>
    <nav class="space-y-4"><button onclick="showScreen('entry'); closeMobileMenu();" id="mobile-entry-tab" class="w-full text-left px-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors"> Vehicle In </button> <button onclick="showScreen('exit'); closeMobileMenu();" id="mobile-exit-tab" class="w-full text-left px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"> Vehicle Out </button> <button onclick="showScreen('dashboard'); closeMobileMenu();" id="mobile-dashboard-tab" class="w-full text-left px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"> Dashboard </button> <button onclick="showScreen('message'); closeMobileMenu();" id="mobile-message-tab" class="w-full text-left px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"> Message </button>
    </nav>
   </div>
  </div>
  <header class="bg-white shadow-lg border-b-4 border-blue-500">
   <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
     <div class="flex items-center space-x-4">
      <div class="bg-blue-500 text-white p-3 rounded-full">
       <svg class="w-8 h-8" fill="currentColor" viewbox="0 0 20 20"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /> <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z" />
       </svg>
      </div>
      <div>
       <h1 id="app-title" class="header-title text-3xl font-bold text-gray-800">GMS FIRST TRACKING</h1>
       <p id="welcome-message" class="header-subtitle text-gray-600">Yarn Inventory</p>
      </div>
     </div><!-- Desktop Navigation -->
     <nav class="desktop-nav space-x-4"><button onclick="showScreen('entry')" id="entry-tab" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors"> Vehicle In </button> <button onclick="showScreen('exit')" id="exit-tab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"> Vehicle Out </button> <button onclick="showScreen('dashboard')" id="dashboard-tab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"> Dashboard </button> <button onclick="showScreen('message')" id="message-tab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"> Message </button>
     </nav><!-- Mobile Navigation Button --> <button onclick="openMobileMenu()" class="mobile-nav text-gray-700 hover:text-gray-900">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg></button>
    </div>
   </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-8"><!-- Entry Screen -->
   <div id="entry-screen" class="screen">
    <div class="form-container bg-white rounded-xl shadow-lg p-8 max-w-2xl mx-auto">
     <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Vehicle In Interface</h2>
     <form id="entry-form" class="space-y-6">
      <div><label for="car-type" class="block text-sm font-medium text-gray-700 mb-2">গাড়ির ধরণ</label> <select id="car-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">নির্বাচন করুন</option> <option value="Import Yarn">Import Yarn</option> <option value="Local Yarn">Local Yarn</option> <option value="S-5 Out Side">S-5 Out Side</option> <option value="Knitting">Knitting</option> <option value="Dyeing">Dyeing</option> <option value="GMS TEXTILES">GMS TEXTILES</option> </select>
      </div>
      <div><label for="car-name" class="block text-sm font-medium text-gray-700 mb-2">গাড়ির নাম</label> <input type="text" id="car-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="গাড়ির নাম লিখুন">
      </div>
      <div><label for="company-name" class="block text-sm font-medium text-gray-700 mb-2">কোম্পানির নাম</label> <input type="text" id="company-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="কোম্পানির নাম লিখুন">
      </div>
      <div><label for="in-time" class="block text-sm font-medium text-gray-700 mb-2">প্রবেশের সময়</label> <input type="datetime-local" id="in-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
      <div class="flex space-x-4 mobile-stack"><button type="submit" id="entry-submit" class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 transition-colors"> In </button> <button type="button" onclick="clearEntryForm()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors"> Clear </button>
      </div>
     </form>
    </div>
   </div><!-- Exit Screen -->
   <div id="exit-screen" class="screen hidden">
    <div class="form-container bg-white rounded-xl shadow-lg p-8 max-w-2xl mx-auto">
     <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Vehicle Out Interface</h2>
     <form id="exit-form" class="space-y-6">
      <div><label for="exit-car-select" class="block text-sm font-medium text-gray-700 mb-2">গাড়ির নাম নির্বাচন করুন</label> <select id="exit-car-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">কোম্পানির ভিতরে থাকা গাড়ি নির্বাচন করুন</option> </select>
      </div>
      <div><label for="exit-person-name" class="block text-sm font-medium text-gray-700 mb-2">যে ব্যক্তি আউট করবে তার নাম</label> <input type="text" id="exit-person-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ব্যক্তির নাম লিখুন">
      </div>
      <div><label for="out-time" class="block text-sm font-medium text-gray-700 mb-2">প্রস্থানের সময়</label> <input type="datetime-local" id="out-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
      <div><label for="exit-comment" class="block text-sm font-medium text-gray-700 mb-2">মন্তব্য (ঐচ্ছিক)</label> <textarea id="exit-comment" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="কোন বিশেষ মন্তব্য থাকলে এখানে লিখুন..."></textarea>
      </div>
      <div id="duration-display" class="hidden bg-blue-50 p-4 rounded-lg">
       <h3 class="font-semibold text-blue-800 mb-2">মোট সময়:</h3>
       <p id="duration-text" class="text-blue-700 text-lg"></p>
      </div><!-- Load Point Section (Hidden by default) -->
      <div id="load-point-section" class="hidden space-y-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
       <h3 class="text-lg font-semibold text-blue-800">Load Point Complete Location</h3>
       <div><label for="load-point-select" class="block text-sm font-medium text-gray-700 mb-2">Load Point নির্বাচন করুন</label> <select id="load-point-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Load Point নির্বাচন করুন</option> <option value="G-1">G-1</option> <option value="G-2">G-2</option> <option value="G-3">G-3</option> <option value="G-6">G-6</option> <option value="G-7">G-7</option> <option value="G-9">G-9</option> <option value="Finish">Finish</option> </select>
       </div>
       <div class="flex space-x-4 mobile-stack"><button type="button" id="update-load-point" disabled class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"> Update Load Point </button>
       </div><!-- Load Point History -->
       <div id="load-point-history" class="hidden mt-4 p-3 bg-white rounded-lg border">
        <h4 class="text-sm font-semibold text-gray-700 mb-2">Load Point History:</h4>
        <div id="load-point-list" class="space-y-1 text-sm"><!-- Load point history will be populated here -->
        </div>
       </div>
      </div>
      <div class="flex space-x-4 mobile-stack"><button type="submit" id="exit-submit" class="flex-1 bg-red-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-600 transition-colors"> Out </button> <button type="button" onclick="clearExitForm()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors"> Clear </button>
      </div>
     </form>
    </div>
   </div><!-- Message Screen -->
   <div id="message-screen" class="screen hidden">
    <div class="space-y-8">
     <div class="bg-white rounded-xl shadow-lg p-8 max-w-2xl mx-auto">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Message Board</h2>
      <form id="message-form" class="space-y-6 mb-8">
       <div><label for="message-name" class="block text-sm font-medium text-gray-700 mb-2">আপনার নাম</label> <input type="text" id="message-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="আপনার নাম লিখুন" maxlength="50">
       </div>
       <div><label for="message-text" class="block text-sm font-medium text-gray-700 mb-2">মেসেজ (সর্বোচ্চ ৫০০ অক্ষর)</label> <textarea id="message-text" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="আপনার মেসেজ লিখুন..." maxlength="500"></textarea>
        <div class="text-right text-sm text-gray-500 mt-1"><span id="char-count">0</span>/500
        </div>
       </div>
       <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
        <div class="flex items-center">
         <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
         </svg><span class="text-yellow-800 text-sm font-medium">মেসেজটি ২৪ ঘন্টা পর অটোমেটিক ডিলিট হয়ে যাবে</span>
        </div>
       </div>
       <div class="flex space-x-4 mobile-stack"><button type="submit" id="message-submit" class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-600 transition-colors"> Send Message </button> <button type="button" onclick="clearMessageForm()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors"> Clear </button>
       </div>
      </form>
     </div><!-- Messages Display -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-bold text-gray-800">সব মেসেজ</h3><button onclick="refreshMessages()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors"> Refresh </button>
      </div>
      <div id="messages-container" class="space-y-4">
       <div class="text-center text-gray-500 py-8">
        No messages yet
       </div>
      </div>
     </div>
    </div>
   </div><!-- Dashboard Screen -->
   <div id="dashboard-screen" class="screen hidden">
    <div class="space-y-8">
     <div class="dashboard-container bg-white rounded-xl shadow-lg p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
       <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
       <div class="flex space-x-4 mobile-stack w-full sm:w-auto"><button onclick="refreshDashboard()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors flex-1 sm:flex-none"> Refresh </button> <button onclick="exportData()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex-1 sm:flex-none"> Export </button>
       </div>
      </div><!-- Date Filter Section -->
      <div class="bg-gray-50 p-4 rounded-lg mb-6">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">তারিখ অনুযায়ী ফিল্টার</h3>
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div><label for="filter-from-date" class="block text-sm font-medium text-gray-700 mb-2">শুরুর তারিখ</label> <input type="date" id="filter-from-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="filter-to-date" class="block text-sm font-medium text-gray-700 mb-2">শেষের তারিখ</label> <input type="date" id="filter-to-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="filter-status" class="block text-sm font-medium text-gray-700 mb-2">স্ট্যাটাস</label> <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">সব স্ট্যাটাস</option> <option value="ভিতরে">ভিতরে</option> <option value="বাহিরে">বাহিরে</option> </select>
        </div>
        <div class="flex space-x-2"><button onclick="applyDateFilter()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors flex-1"> ফিল্টার করুন </button> <button onclick="clearDateFilter()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex-1"> রিসেট </button>
        </div>
       </div><!-- Quick Date Filters -->
       <div class="mt-4 flex flex-wrap gap-2"><span class="text-sm font-medium text-gray-700 mr-2">দ্রুত নির্বাচন:</span> <button onclick="setQuickFilter('today')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition-colors"> আজ </button> <button onclick="setQuickFilter('yesterday')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition-colors"> গতকাল </button> <button onclick="setQuickFilter('thisWeek')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition-colors"> এই সপ্তাহ </button> <button onclick="setQuickFilter('thisMonth')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm hover:bg-blue-200 transition-colors"> এই মাস </button>
       </div><!-- Filter Status Display -->
       <div id="filter-status-display" class="mt-3 text-sm text-gray-600 hidden"><span class="font-medium">ফিল্টার সক্রিয়:</span> <span id="filter-description"></span>
       </div>
      </div><!-- Statistics Cards -->
      <div class="stats-grid grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
       <div class="bg-blue-50 p-6 rounded-lg">
        <h3 class="text-sm font-medium text-blue-600 mb-3">Total Cars</h3>
        <div class="space-y-1">
         <div class="flex justify-between items-center"><span class="text-sm text-green-600 font-medium">IN:</span> <span id="total-in" class="text-lg font-bold text-green-700">0</span>
         </div>
         <div class="flex justify-between items-center"><span class="text-sm text-red-600 font-medium">OUT:</span> <span id="total-out" class="text-lg font-bold text-red-700">0</span>
         </div>
        </div>
       </div>
       <div class="bg-green-50 p-6 rounded-lg">
        <h3 class="text-sm font-medium text-green-600 mb-3">Currently Inside</h3>
        <div class="text-center">
         <p id="cars-inside" class="text-3xl font-bold text-green-800">0</p>
        </div>
       </div>
       <div class="bg-yellow-50 p-6 rounded-lg">
        <h3 class="text-sm font-medium text-yellow-600 mb-3">Import Yarn</h3>
        <div class="space-y-1">
         <div class="flex justify-between items-center"><span class="text-sm text-green-600 font-medium">IN:</span> <span id="import-yarn-in" class="text-lg font-bold text-green-700">0</span>
         </div>
         <div class="flex justify-between items-center"><span class="text-sm text-red-600 font-medium">OUT:</span> <span id="import-yarn-out" class="text-lg font-bold text-red-700">0</span>
         </div>
        </div>
       </div>
       <div class="bg-purple-50 p-6 rounded-lg">
        <h3 class="text-sm font-medium text-purple-600 mb-3">Local Yarn</h3>
        <div class="space-y-1">
         <div class="flex justify-between items-center"><span class="text-sm text-green-600 font-medium">IN:</span> <span id="local-yarn-in" class="text-lg font-bold text-green-700">0</span>
         </div>
         <div class="flex justify-between items-center"><span class="text-sm text-red-600 font-medium">OUT:</span> <span id="local-yarn-out" class="text-lg font-bold text-red-700">0</span>
         </div>
        </div>
       </div>
      </div><!-- Data Table -->
      <div class="table-container overflow-x-auto">
       <table class="mobile-table w-full border-collapse text-sm">
        <thead>
         <tr class="bg-gray-50">
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Car Name</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Company</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Type</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Entry Time</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Exit Time</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Duration</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Load Points</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Exit By</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Comments</th>
          <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700 text-xs">Status</th>
         </tr>
        </thead>
        <tbody id="data-table-body">
         <tr>
          <td colspan="10" class="border border-gray-200 px-4 py-8 text-center text-gray-500">No data found</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </div>
  </main>
  <script>
        let currentData = [];
        let filteredData = [];
        let currentScreen = 'entry';
        let activeFilter = null;
        let messageData = [];

        // Default configuration
        const defaultConfig = {
            app_title: "Gms Vendor Tracking",
            welcome_message: "Yarn Inventory",
            primary_color: "#3B82F6",
            secondary_color: "#F8FAFC",
            text_color: "#1F2937",
            success_color: "#10B981",
            danger_color: "#EF4444"
        };

        // Data Handler for Firebase
        const dataHandler = {
            onDataChanged(data) {
                console.log('📊 Data updated:', data.length, 'records');
                
                // Separate car data and message data
                const carRecords = data.filter(record => !record.message_type);
                const messageRecords = data.filter(record => record.message_type === 'message');
                
                currentData = carRecords;
                messageData = messageRecords;
                
                updateDashboard();
                updateMessagesDisplay();
                
                // Update exit dropdown if we're on the exit screen
                if (currentScreen === 'exit') {
                    updateExitCarDropdown();
                }
                
                // Show data update notification
                if (data.length > 0) {
                    showToast(`📋 ডাটা আপডেট: ${data.length}টি রেকর্ড লোড হয়েছে`, 'info');
                }
                
                // Auto-delete messages older than 24 hours
                cleanupOldMessages();
            }
        };

        // Element SDK Configuration
        const capabilities = {
            recolorables: [
                {
                    get: () => window.elementSdk?.config?.primary_color || defaultConfig.primary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    }
                },
                {
                    get: () => window.elementSdk?.config?.secondary_color || defaultConfig.secondary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ secondary_color: value });
                        }
                    }
                },
                {
                    get: () => window.elementSdk?.config?.text_color || defaultConfig.text_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ text_color: value });
                        }
                    }
                },
                {
                    get: () => window.elementSdk?.config?.success_color || defaultConfig.success_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ success_color: value });
                        }
                    }
                },
                {
                    get: () => window.elementSdk?.config?.danger_color || defaultConfig.danger_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ danger_color: value });
                        }
                    }
                }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
        };

        async function onConfigChange(config) {
            const appTitle = config.app_title || defaultConfig.app_title;
            const welcomeMessage = config.welcome_message || defaultConfig.welcome_message;
            
            document.getElementById('app-title').textContent = appTitle;
            document.getElementById('welcome-message').textContent = welcomeMessage;
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["app_title", config.app_title || defaultConfig.app_title],
                ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
            ]);
        }

        // Initialize Firebase and SDKs
        async function initializeApp() {
            try {
                showToast('🚀 সিস্টেম শুরু হচ্ছে...', 'info');
                
                // Initialize Firebase listener
                if (window.firebaseDatabase) {
                    const dbRef = window.firebaseRef(window.firebaseDatabase, '/');
                    window.firebaseOnValue(dbRef, (snapshot) => {
                        const data = snapshot.val();
                        const dataArray = data ? Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        })) : [];
                        dataHandler.onDataChanged(dataArray);
                    });
                     showToast('✅ ফায়ারবেস সফলভাবে সংযুক্ত হয়েছে', 'success');
                     console.log('✅ Firebase initialized successfully');
                } else {
                    showToast('⚠️ ফায়ারবেস উপলব্ধ নেই', 'error');
                    console.error('⚠️ Firebase not available');
                }

                // Initialize Element SDK
                if (window.elementSdk) {
                    console.log('🔧 Initializing Element SDK...');
                    await window.elementSdk.init({
                        defaultConfig,
                        onConfigChange,
                        mapToCapabilities: () => capabilities,
                        mapToEditPanelValues
                    });
                    console.log('✅ Element SDK initialized successfully');
                } else {
                    console.log('⚠️ Element SDK not available');
                }

                // Set current time for entry form
                setCurrentTime();
                
                setTimeout(() => {
                    showToast('🎯 সিস্টেম প্রস্তুত! গাড়ি ইন করতে পারেন', 'success');
                }, 1500);
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                showToast('❌ সিস্টেম শুরু করতে সমস্যা হয়েছে: ' + error.message, 'error');
            }
        }

        // Mobile Menu Functions
        function openMobileMenu() {
            document.getElementById('mobile-menu').classList.add('open');
            document.getElementById('mobile-overlay').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            document.getElementById('mobile-menu').classList.remove('open');
            document.getElementById('mobile-overlay').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Screen Navigation
        function showScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });

            // Show selected screen
            document.getElementById(`${screenName}-screen`).classList.remove('hidden');

            // Update desktop tab styles
            document.querySelectorAll('.desktop-nav button').forEach(tab => {
                tab.classList.remove('bg-blue-500', 'text-white');
                tab.classList.add('bg-gray-200', 'text-gray-700');
            });

            const desktopTab = document.getElementById(`${screenName}-tab`);
            if (desktopTab) {
                desktopTab.classList.remove('bg-gray-200', 'text-gray-700');
                desktopTab.classList.add('bg-blue-500', 'text-white');
            }

            // Update mobile tab styles
            document.querySelectorAll('#mobile-menu nav button').forEach(tab => {
                tab.classList.remove('bg-blue-500', 'text-white');
                tab.classList.add('bg-gray-200', 'text-gray-700');
            });

            const mobileTab = document.getElementById(`mobile-${screenName}-tab`);
            if (mobileTab) {
                mobileTab.classList.remove('bg-gray-200', 'text-gray-700');
                mobileTab.classList.add('bg-blue-500', 'text-white');
            }

            currentScreen = screenName;

            if (screenName === 'exit') {
                setCurrentTimeForExit();
                updateExitCarDropdown();
            } else if (screenName === 'entry') {
                setCurrentTime();
            } else if (screenName === 'message') {
                updateMessagesDisplay();
            }
        }

        // Update exit car dropdown with cars currently inside
        function updateExitCarDropdown() {
            const dropdown = document.getElementById('exit-car-select');
            const carsInside = currentData.filter(car => car.status === 'ভিতরে');
            
            // Clear existing options except the first one
            dropdown.innerHTML = '<option value="">কোম্পানির ভিতরে থাকা গাড়ি নির্বাচন করুন</option>';
            
            if (carsInside.length === 0) {
                dropdown.innerHTML = '<option value="">কোন গাড়ি কোম্পানির ভিতরে নেই</option>';
                return;
            }
            
            carsInside.forEach(car => {
                const option = document.createElement('option');
                option.value = car.id;
                option.textContent = `${car.car_name} (${car.car_type} - ${car.company_name})`;
                dropdown.appendChild(option);
            });
        }

        // Handle car selection change in exit form
        document.getElementById('exit-car-select').addEventListener('change', function() {
            const selectedCarId = this.value;
            const loadPointSection = document.getElementById('load-point-section');
            
            if (!selectedCarId) {
                loadPointSection.classList.add('hidden');
                return;
            }
            
            const selectedCar = currentData.find(car => car.id === selectedCarId);
            
            if (selectedCar && (selectedCar.car_type === 'S-5 Out Side' || selectedCar.car_type === 'GMS TEXTILES')) {
                loadPointSection.classList.remove('hidden');
                loadCurrentLoadPointHistory(selectedCar);
                updateLoadPointButtons();
            } else {
                loadPointSection.classList.add('hidden');
            }
        });

        // Load current load point history for selected car
        function loadCurrentLoadPointHistory(car) {
            const loadPointHistory = document.getElementById('load-point-history');
            const loadPointList = document.getElementById('load-point-list');
            
            if (car.load_points && car.load_points !== '') {
                try {
                    const loadPoints = JSON.parse(car.load_points);
                    const loadPointTimes = car.load_point_times ? JSON.parse(car.load_point_times) : {};
                    
                    if (loadPoints.length > 0) {
                        loadPointHistory.classList.remove('hidden');
                        
                        const historyHTML = loadPoints.map((point, index) => {
                            const time = loadPointTimes[point] ? new Date(loadPointTimes[point]).toLocaleString('bn-BD') : '';
                            const duration = index > 0 ? calculateLoadPointDuration(loadPointTimes, loadPoints, index) : '';
                            
                            return `<div class="flex justify-between items-center py-1 border-b border-gray-200 last:border-b-0">
                                <span class="font-medium">${point}</span>
                                <div class="text-right">
                                    <div class="text-xs text-gray-600">${time}</div>
                                    ${duration ? `<div class="text-xs text-blue-600">${duration}</div>` : ''}
                                </div>
                            </div>`;
                        }).join('');
                        
                        loadPointList.innerHTML = historyHTML;
                    } else {
                        loadPointHistory.classList.add('hidden');
                    }
                } catch (e) {
                    loadPointHistory.classList.add('hidden');
                }
            } else {
                loadPointHistory.classList.add('hidden');
            }
        }

        // Calculate duration between load points
        function calculateLoadPointDuration(loadPointTimes, loadPoints, currentIndex) {
            if (currentIndex === 0) return '';
            
            const currentPoint = loadPoints[currentIndex];
            const previousPoint = loadPoints[currentIndex - 1];
            
            const currentTime = loadPointTimes[currentPoint];
            const previousTime = loadPointTimes[previousPoint];
            
            if (!currentTime || !previousTime) return '';
            
            const diffMs = new Date(currentTime) - new Date(previousTime);
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            if (hours > 0) {
                return `${hours}ঘ ${minutes}মি`;
            } else {
                return `${minutes}মি`;
            }
        }

        // Handle load point selection change
        document.getElementById('load-point-select').addEventListener('change', function() {
            updateLoadPointButtons();
        });

        // Update load point buttons based on selection
        function updateLoadPointButtons() {
            const selectedLoadPoint = document.getElementById('load-point-select').value;
            const updateButton = document.getElementById('update-load-point');
            const exitButton = document.getElementById('exit-submit');
            
            if (!selectedLoadPoint) {
                updateButton.disabled = true;
                exitButton.disabled = false;
                return;
            }
            
            if (selectedLoadPoint === 'Finish') {
                updateButton.disabled = true;
                exitButton.disabled = false;
            } else {
                updateButton.disabled = false;
                exitButton.disabled = true;
            }
        }

        // Handle update load point button click
        document.getElementById('update-load-point').addEventListener('click', async function() {
            const selectedCarId = document.getElementById('exit-car-select').value;
            const selectedLoadPoint = document.getElementById('load-point-select').value;
            
            if (!selectedCarId || !selectedLoadPoint) {
                showToast('গাড়ি এবং Load Point নির্বাচন করুন', 'error');
                return;
            }
            
            const existingCar = currentData.find(car => car.id === selectedCarId);
            if (!existingCar) {
                showToast('নির্বাচিত গাড়িটি পাওয়া যায়নি', 'error');
                return;
            }
            
            this.classList.add('loading');
            this.textContent = 'Updating...';
            
            // Get current load points and times
            let loadPoints = [];
            let loadPointTimes = {};
            
            if (existingCar.load_points && existingCar.load_points !== '') {
                try {
                    loadPoints = JSON.parse(existingCar.load_points);
                    loadPointTimes = existingCar.load_point_times ? JSON.parse(existingCar.load_point_times) : {};
                } catch (e) {
                    loadPoints = [];
                    loadPointTimes = {};
                }
            }
            
            // Add new load point if not already exists
            if (!loadPoints.includes(selectedLoadPoint)) {
                loadPoints.push(selectedLoadPoint);
                loadPointTimes[selectedLoadPoint] = new Date().toISOString();
            }
            
            const updatedCarData = {
                load_points: JSON.stringify(loadPoints),
                load_point_times: JSON.stringify(loadPointTimes),
                current_load_point: selectedLoadPoint
            };
            
            if (window.firebaseDatabase) {
                try {
                    const carRef = window.firebaseRef(window.firebaseDatabase, '/' + selectedCarId);
                    await window.firebaseUpdate(carRef, updatedCarData);
                    showToast(`Load Point "${selectedLoadPoint}" আপডেট হয়েছে`, 'success');
                    document.getElementById('load-point-select').value = '';
                    updateLoadPointButtons();
                } catch(error) {
                    showToast('Load Point আপডেট করতে সমস্যা হয়েছে', 'error');
                    console.error("Firebase update error:", error);
                }
            }
            
            this.classList.remove('loading');
            this.textContent = 'Update Load Point';
        });

        // Set current time
        function setCurrentTime() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('in-time').value = localDateTime;
        }

        function setCurrentTimeForExit() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('out-time').value = localDateTime;
        }

        // Entry Form Handler
        document.getElementById('entry-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const carType = document.getElementById('car-type').value;
            const carName = document.getElementById('car-name').value;
            const companyName = document.getElementById('company-name').value;
            const inTime = document.getElementById('in-time').value;

            if (!carType || !carName || !companyName || !inTime) {
                showToast('সব ফিল্ড পূরণ করুন', 'error');
                return;
            }

            if (currentData.length >= 999) {
                showToast('সর্বোচ্চ ৯৯৯টি রেকর্ডের সীমা পৌঁছেছে। কিছু রেকর্ড মুছে দিন।', 'error');
                return;
            }

            const submitButton = document.getElementById('entry-submit');
            submitButton.classList.add('loading');
            submitButton.textContent = '💾 সেভ হচ্ছে...';
            submitButton.disabled = true;

            showToast('গাড়ির তথ্য সেভ করা হচ্ছে...', 'info');

            const carData = {
                car_name: carName,
                company_name: companyName,
                car_type: carType,
                in_time: new Date(inTime).toISOString(),
                out_time: '',
                duration: '',
                status: 'ভিতরে',
                exit_person_name: '',
                exit_comment: '',
                load_points: '',
                load_point_times: '',
                current_load_point: ''
            };

            try {
                if (window.firebaseDatabase) {
                    const newCarRef = window.firebasePush(window.firebaseRef(window.firebaseDatabase, '/'));
                    await window.firebaseSet(newCarRef, carData);
                    showToast(`✅ "${carName}" গাড়িটি সফলভাবে ইন হয়েছে!`, 'success');
                    clearEntryForm();
                } else {
                    showToast('❌ ডাটা সিস্টেম উপলব্ধ নেই', 'error');
                }
            } catch (error) {
                showToast('❌ সিস্টেম এরর: ' + error.message, 'error');
                console.error('System error:', error);
            }

            submitButton.classList.remove('loading');
            submitButton.textContent = 'In';
            submitButton.disabled = false;
        });

        // Exit Form Handler
        document.getElementById('exit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedCarId = document.getElementById('exit-car-select').value;
            const personName = document.getElementById('exit-person-name').value;
            const outTime = document.getElementById('out-time').value;
            const exitComment = document.getElementById('exit-comment').value;

            if (!selectedCarId || !personName || !outTime) {
                showToast('সব ফিল্ড পূরণ করুন', 'error');
                return;
            }

            const existingCar = currentData.find(car => 
                car.id === selectedCarId && car.status === 'ভিতরে'
            );

            if (!existingCar) {
                showToast('নির্বাচিত গাড়িটি পাওয়া যায়নি', 'error');
                return;
            }

            const submitButton = document.getElementById('exit-submit');
            submitButton.classList.add('loading');
            submitButton.textContent = 'Updating...';

            const inDateTime = new Date(existingCar.in_time);
            const outDateTime = new Date(outTime);
            const duration = calculateDuration(inDateTime, outDateTime);

            const updatedCarData = {
                out_time: outDateTime.toISOString(),
                duration: duration,
                status: 'বাহিরে',
                exit_person_name: personName,
                exit_comment: exitComment
            };

            if (window.firebaseDatabase) {
                 try {
                    const carRef = window.firebaseRef(window.firebaseDatabase, '/' + selectedCarId);
                    await window.firebaseUpdate(carRef, updatedCarData);
                    showToast('গাড়ির প্রস্থানের তথ্য আপডেট হয়েছে', 'success');
                    showDuration(duration);
                    clearExitForm();
                } catch(error) {
                    showToast('ডাটা আপডেট করতে সমস্যা হয়েছে', 'error');
                    console.error("Firebase update error:", error);
                }
            }

            submitButton.classList.remove('loading');
            submitButton.textContent = 'Out';
        });

        // Calculate duration
        function calculateDuration(inTime, outTime) {
            const diffMs = outTime - inTime;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${diffHours} ঘন্টা ${diffMinutes} মিনিট`;
        }

        // Show duration
        function showDuration(duration) {
            document.getElementById('duration-text').textContent = duration;
            document.getElementById('duration-display').classList.remove('hidden');
        }

        // Clear forms
        function clearEntryForm() {
            document.getElementById('entry-form').reset();
            setCurrentTime();
        }

        function clearExitForm() {
            document.getElementById('exit-form').reset();
            document.getElementById('duration-display').classList.add('hidden');
            document.getElementById('load-point-section').classList.add('hidden');
            document.getElementById('load-point-history').classList.add('hidden');
            document.getElementById('load-point-select').value = '';
            setCurrentTimeForExit();
            updateExitCarDropdown();
            updateLoadPointButtons();
        }

        // Dashboard functions
        function updateDashboard() {
            const dataToShow = activeFilter ? filteredData : currentData;
            
            // Total Cars Statistics
            const totalIn = dataToShow.length;
            const totalOut = dataToShow.filter(car => car.status === 'বাহিরে').length;
            const carsInside = dataToShow.filter(car => car.status === 'ভিতরে').length;
            
            // Import Yarn Statistics
            const importYarnData = dataToShow.filter(car => car.car_type === 'Import Yarn');
            const importYarnIn = importYarnData.length;
            const importYarnOut = importYarnData.filter(car => car.status === 'বাহিরে').length;
            
            // Local Yarn Statistics
            const localYarnData = dataToShow.filter(car => car.car_type === 'Local Yarn');
            const localYarnIn = localYarnData.length;
            const localYarnOut = localYarnData.filter(car => car.status === 'বাহিরে').length;

            // Update Total Cars
            document.getElementById('total-in').textContent = totalIn;
            document.getElementById('total-out').textContent = totalOut;
            
            // Update Currently Inside
            document.getElementById('cars-inside').textContent = carsInside;
            
            // Update Import Yarn
            document.getElementById('import-yarn-in').textContent = importYarnIn;
            document.getElementById('import-yarn-out').textContent = importYarnOut;
            
            // Update Local Yarn
            document.getElementById('local-yarn-in').textContent = localYarnIn;
            document.getElementById('local-yarn-out').textContent = localYarnOut;

            updateDataTable();
        }

        function updateDataTable() {
            const tbody = document.getElementById('data-table-body');
            const dataToShow = activeFilter ? filteredData.sort((a,b) => new Date(b.in_time) - new Date(a.in_time)) : currentData.sort((a,b) => new Date(b.in_time) - new Date(a.in_time));
            
            if (dataToShow.length === 0) {
                const message = activeFilter ? 'ফিল্টার অনুযায়ী কোন ডাটা পাওয়া যায়নি' : 'No data found';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = dataToShow.map(car => {
                const inTime = new Date(car.in_time).toLocaleString('en-US', {
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const outTime = car.out_time ? new Date(car.out_time).toLocaleString('en-US', {
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
                const statusClass = car.status === 'ভিতরে' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
                const statusText = car.status === 'ভিতরে' ? 'Inside' : 'Outside';
                const exitPersonName = car.exit_person_name || '-';
                const exitComment = car.exit_comment || '-';
                
                // Format load points display
                let loadPointsDisplay = '-';
                if (car.load_points && car.load_points !== '') {
                    try {
                        const loadPoints = JSON.parse(car.load_points);
                        const loadPointTimes = car.load_point_times ? JSON.parse(car.load_point_times) : {};
                        
                        loadPointsDisplay = loadPoints.map((point, index) => {
                            const time = loadPointTimes[point] ? new Date(loadPointTimes[point]).toLocaleString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                            const duration = index > 0 ? calculateLoadPointDuration(loadPointTimes, loadPoints, index) : '';
                            return `${point}${time ? ` (${time})` : ''}${duration ? ` [${duration}]` : ''}`;
                        }).join(', ');
                    } catch (e) {
                        loadPointsDisplay = '-';
                    }
                }
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-2 py-2 text-xs break-words">${car.car_name}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs break-words">${car.company_name}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs break-words">${car.car_type}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs whitespace-nowrap">${inTime}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs whitespace-nowrap">${outTime}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs break-words">${car.duration || '-'}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs break-words max-w-xs">${loadPointsDisplay}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs break-words">${exitPersonName}</td>
                        <td class="border border-gray-200 px-2 py-2 text-xs break-words max-w-xs">${exitComment}</td>
                        <td class="border border-gray-200 px-2 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function refreshDashboard() {
            updateDashboard();
            showToast('ড্যাশবোর্ড রিফ্রেশ হয়েছে', 'success');
        }

        // Date Filter Functions
        function applyDateFilter() {
            const fromDate = document.getElementById('filter-from-date').value;
            const toDate = document.getElementById('filter-to-date').value;
            const status = document.getElementById('filter-status').value;

            if (!fromDate && !toDate && !status) {
                showToast('অন্তত একটি ফিল্টার নির্বাচন করুন', 'error');
                return;
            }

            filteredData = currentData.filter(car => {
                let matchesDate = true;
                let matchesStatus = true;

                if (fromDate || toDate) {
                    const carDateObj = new Date(car.in_time);
                    
                    if (fromDate) {
                        const fromDateObj = new Date(fromDate);
                        fromDateObj.setHours(0, 0, 0, 0);
                        matchesDate = matchesDate && carDateObj >= fromDateObj;
                    }
                    
                    if (toDate) {
                        const toDateObj = new Date(toDate);
                        toDateObj.setHours(23, 59, 59, 999);
                        matchesDate = matchesDate && carDateObj <= toDateObj;
                    }
                }

                if (status) {
                    matchesStatus = car.status === status;
                }

                return matchesDate && matchesStatus;
            });

            activeFilter = {
                fromDate,
                toDate,
                status
            };

            updateFilterStatusDisplay();
            updateDashboard();
            
            const resultCount = filteredData.length;
            showToast(`ফিল্টার প্রয়োগ হয়েছে - ${resultCount}টি রেকর্ড পাওয়া গেছে`, 'success');
        }

        function clearDateFilter() {
            document.getElementById('filter-from-date').value = '';
            document.getElementById('filter-to-date').value = '';
            document.getElementById('filter-status').value = '';
            
            activeFilter = null;
            filteredData = [];
            
            document.getElementById('filter-status-display').classList.add('hidden');
            updateDashboard();
            showToast('ফিল্টার রিসেট হয়েছে', 'success');
        }

        function setQuickFilter(type) {
            const today = new Date();
            let fromDate, toDate;

            switch (type) {
                case 'today':
                    fromDate = toDate = today.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    fromDate = toDate = yesterday.toISOString().split('T')[0];
                    break;
                case 'thisWeek':
                    const dayOfWeek = today.getDay();
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Adjust for Sunday
                    fromDate = startOfWeek.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                case 'thisMonth':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    fromDate = startOfMonth.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
            }

            document.getElementById('filter-from-date').value = fromDate;
            document.getElementById('filter-to-date').value = toDate;
            document.getElementById('filter-status').value = '';

            applyDateFilter();
        }

        function updateFilterStatusDisplay() {
            const display = document.getElementById('filter-status-display');
            const description = document.getElementById('filter-description');
            
            if (!activeFilter) {
                display.classList.add('hidden');
                return;
            }

            let filterText = [];
            
            if (activeFilter.fromDate && activeFilter.toDate) {
                if (activeFilter.fromDate === activeFilter.toDate) {
                    filterText.push(`তারিখ: ${new Date(activeFilter.fromDate + 'T00:00:00').toLocaleDateString('bn-BD')}`);
                } else {
                    filterText.push(`তারিখ: ${new Date(activeFilter.fromDate + 'T00:00:00').toLocaleDateString('bn-BD')} থেকে ${new Date(activeFilter.toDate + 'T00:00:00').toLocaleDateString('bn-BD')}`);
                }
            } else if (activeFilter.fromDate) {
                filterText.push(`${new Date(activeFilter.fromDate + 'T00:00:00').toLocaleDateString('bn-BD')} এর পর থেকে`);
            } else if (activeFilter.toDate) {
                filterText.push(`${new Date(activeFilter.toDate + 'T00:00:00').toLocaleDateString('bn-BD')} পর্যন্ত`);
            }
            
            if (activeFilter.status) {
                filterText.push(`স্ট্যাটাস: ${activeFilter.status}`);
            }
            
            description.textContent = filterText.join(', ');
            display.classList.remove('hidden');
        }

        function exportData() {
            const dataToExport = activeFilter ? filteredData : currentData;
            
            if (dataToExport.length === 0) {
                showToast('এক্সপোর্ট করার জন্য কোন ডাটা নেই', 'error');
                return;
            }

            const csvContent = generateCSV(dataToExport);
            const filename = activeFilter ? 'filtered-car-tracking-data.csv' : 'car-tracking-data.csv';
            downloadCSV(csvContent, filename);
            
            const filterText = activeFilter ? ' (ফিল্টার করা)' : '';
            showToast(`${dataToExport.length}টি রেকর্ড সফলভাবে এক্সপোর্ট হয়েছে${filterText}`, 'success');
        }

        function generateCSV(dataToExport = currentData) {
            const headers = ['গাড়ির নাম', 'কোম্পানি', 'ধরণ', 'প্রবেশের সময়', 'প্রস্থানের সময়', 'মোট সময়', 'Load Points', 'আউট করেছে', 'মন্তব্য', 'স্ট্যাটাস'];
            const rows = dataToExport.map(car => {
                let loadPointsCSV = '';
                if (car.load_points && car.load_points !== '') {
                    try {
                        const loadPoints = JSON.parse(car.load_points);
                        const loadPointTimes = car.load_point_times ? JSON.parse(car.load_point_times) : {};
                        
                        loadPointsCSV = loadPoints.map((point, index) => {
                            const time = loadPointTimes[point] ? new Date(loadPointTimes[point]).toLocaleString('bn-BD') : '';
                            const duration = index > 0 ? calculateLoadPointDuration(loadPointTimes, loadPoints, index) : '';
                            return `"${point}${time ? ` (${time})` : ''}${duration ? ` [${duration}]` : ''}"`;
                        }).join('; ');
                    } catch (e) {
                        loadPointsCSV = '';
                    }
                }
                
                return [
                    `"${car.car_name}"`,
                    `"${car.company_name}"`,
                    `"${car.car_type}"`,
                    `"${new Date(car.in_time).toLocaleString('bn-BD')}"`,
                    `"${car.out_time ? new Date(car.out_time).toLocaleString('bn-BD') : ''}"`,
                    `"${car.duration || ''}"`,
                    `"${loadPointsCSV}"`,
                    `"${car.exit_person_name || ''}"`,
                    `"${(car.exit_comment || '').replace(/"/g, '""')}"`,
                    `"${car.status}"`
                ];
            });

            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg fade-in`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        document.getElementById('message-text').addEventListener('input', function() {
            const charCount = this.value.length;
            document.getElementById('char-count').textContent = charCount;
        });

        document.getElementById('message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageName = document.getElementById('message-name').value.trim();
            const messageText = document.getElementById('message-text').value.trim();

            if (!messageName || !messageText) {
                showToast('নাম এবং মেসেজ দুটোই লিখুন', 'error');
                return;
            }

            const submitButton = document.getElementById('message-submit');
            submitButton.classList.add('loading');
            submitButton.textContent = 'Sending...';
            submitButton.disabled = true;

            const messageRecord = {
                message_name: messageName,
                message_text: messageText,
                message_time: new Date().toISOString(),
                message_type: 'message'
            };

            try {
                if (window.firebaseDatabase) {
                    const newMessageRef = window.firebasePush(window.firebaseRef(window.firebaseDatabase, '/'));
                    await window.firebaseSet(newMessageRef, messageRecord);
                    showToast(`✅ "${messageName}" এর মেসেজ পাঠানো হয়েছে!`, 'success');
                    clearMessageForm();
                } else {
                    showToast('❌ মেসেজ সিস্টেম উপলব্ধ নেই', 'error');
                }
            } catch (error) {
                showToast('❌ সিস্টেম এরর: ' + error.message, 'error');
            }

            submitButton.classList.remove('loading');
            submitButton.textContent = 'Send Message';
            submitButton.disabled = false;
        });

        function clearMessageForm() {
            document.getElementById('message-form').reset();
            document.getElementById('char-count').textContent = 0;
        }

        function updateMessagesDisplay() {
            const container = document.getElementById('messages-container');
            
            if (messageData.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8">No messages yet</div>`;
                return;
            }

            const sortedMessages = [...messageData].sort((a, b) => new Date(b.message_time) - new Date(a.message_time));

            container.innerHTML = sortedMessages.map(message => {
                const messageTime = new Date(message.message_time);
                const timeAgo = getTimeAgo(messageTime);
                const timeLeft = getTimeLeft(messageTime);
                
                return `
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800">${message.message_name}</h4>
                            <div class="text-right">
                                <div class="text-xs text-gray-500">${timeAgo}</div>
                                <div class="text-xs text-red-500">${timeLeft}</div>
                            </div>
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap">${message.message_text}</p>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(messageTime) {
            const now = new Date();
            const diffMs = now - messageTime;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMinutes / 60);
            
            if (diffHours > 0) return `${diffHours} ঘন্টা আগে`;
            if (diffMinutes > 0) return `${diffMinutes} মিনিট আগে`;
            return 'এইমাত্র';
        }

        function getTimeLeft(messageTime) {
            const deleteTime = new Date(messageTime.getTime() + 24 * 60 * 60 * 1000);
            const now = new Date();
            const diffMs = deleteTime - now;
            
            if (diffMs <= 0) return 'ডিলিট হবে';
            
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (diffHours > 0) return `${diffHours}ঘ ${diffMinutes}মি বাকি`;
            return `${diffMinutes}মি বাকি`;
        }

        function refreshMessages() {
            updateMessagesDisplay();
            showToast('মেসেজ রিফ্রেশ হয়েছে', 'success');
        }

        async function cleanupOldMessages() {
            const now = new Date();
            const messagesToDelete = messageData.filter(message => {
                const messageTime = new Date(message.message_time);
                const diffHours = (now - messageTime) / (1000 * 60 * 60);
                return diffHours >= 24;
            });

            if (messagesToDelete.length > 0 && window.firebaseDatabase) {
                let deletedCount = 0;
                for (const message of messagesToDelete) {
                    try {
                        const messageRef = window.firebaseRef(window.firebaseDatabase, '/' + message.id);
                        await window.firebaseRemove(messageRef);
                        console.log(`🗑️ Auto-deleted message from ${message.message_name}`);
                        deletedCount++;
                    } catch (error) {
                        console.error('Error deleting old message:', error);
                    }
                }
                
                if (deletedCount > 0) {
                    showToast(`🗑️ ${deletedCount}টি পুরানো মেসেজ অটো ডিলিট হয়েছে`, 'info');
                }
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 </body>
</html>
    
  </body>
  
</html>
